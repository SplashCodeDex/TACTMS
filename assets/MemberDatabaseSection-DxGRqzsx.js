import{c as G,j as e,A as Se,m as Ie,C as de,r as o,B as b,M as le,b as ze,d as Ae,e as Le,g as Re,D as Oe,h as Ee,w as Fe,R as $e,y as Pe,z as fe,E as De,K as Be,F as Ue,H as He,o as Ne,X as ie,I as _e,J as qe,N as Te,O as Ve,Q as se,V as we,W as We,Y as Ke,Z as Ge,$ as Je,a0 as Ze,a1 as me,a2 as xe,a3 as he,a4 as Qe,T as Xe,a5 as Ye,a6 as et,a7 as tt,a8 as st,i as rt,a9 as te,k as ae,aa as at,ab as nt,ac as ot,ad as it,S as lt,ae as ce,af as ct,ag as dt}from"./index-D2A2AOn4.js";import{F as mt,U as pe,H as be}from"./schemas-CVI18EiS.js";import{R as ke}from"./rotate-ccw-DAa-uQVw.js";import{A as ve}from"./arrow-right-BAxwy3no.js";import{E as xt}from"./eye-CesgGryg.js";import{D as Me}from"./download-WcLx35U_.js";/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=G("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=G("ArrowRightToLine",[["path",{d:"M17 12H3",key:"8awo09"}],["path",{d:"m11 18 6-6-6-6",key:"8c2y43"}],["path",{d:"M21 5v14",key:"nzette"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=G("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=G("FileDown",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=G("FileUp",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 12v6",key:"3ahymv"}],["path",{d:"m15 15-3-3-3 3",key:"15xj92"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=G("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=G("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=G("MoveVertical",[["polyline",{points:"8 18 12 22 16 18",key:"1uutw3"}],["polyline",{points:"8 6 12 2 16 6",key:"d60sxy"}],["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=G("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=G("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=G("Undo2",[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]]);/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=G("WandSparkles",[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]]),vt=async(x,S,p,z,y)=>{throw new Error("API Key is missing")},je=({checked:x,onChange:S,disabled:p=!1,className:z=""})=>e.jsx("button",{type:"button",role:"checkbox","aria-checked":x,disabled:p,onClick:()=>!p&&S(!x),className:`
        relative flex items-center justify-center w-6 h-6 rounded-full border-2 transition-all duration-200
        ${p?"opacity-50 cursor-not-allowed":"cursor-pointer"}
        ${x?"bg-[var(--primary-accent-start)] border-[var(--primary-accent-start)]":"bg-transparent border-[var(--text-muted)] hover:border-[var(--primary-accent-start)]"}
        ${z}
      `,children:e.jsx(Se,{children:x&&e.jsx(Ie.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0},transition:{duration:.2,ease:"backOut"},children:e.jsx(de,{size:14,className:"text-white stroke-[3]"})})})}),yt=({isOpen:x,onClose:S,onConfirm:p,existingAssemblies:z})=>{const[y,h]=o.useState(""),[A,a]=o.useState(null),[u,j]=o.useState(!1),[M,N]=o.useState(""),$=o.useRef(null);o.useEffect(()=>{x&&(h(""),a(null),N(""),j(!1))},[x]);const v=n=>{if(n.target.files&&n.target.files[0]){const I=n.target.files[0];I.name.endsWith(".xlsx")||I.name.endsWith(".xls")?(a(I),N("")):N("Please upload a valid Excel file (.xlsx or .xls)")}},O=n=>{n.preventDefault(),j(!0)},L=n=>{n.preventDefault(),j(!1)},P=n=>{if(n.preventDefault(),j(!1),n.dataTransfer.files&&n.dataTransfer.files[0]){const I=n.dataTransfer.files[0];I.name.endsWith(".xlsx")||I.name.endsWith(".xls")?(a(I),N("")):N("Please upload a valid Excel file (.xlsx or .xls)")}},R=()=>{if(!y.trim()){N("Assembly name is required");return}if(z.includes(y.trim())){N("An assembly with this name already exists");return}p(y.trim(),A),S()},g=e.jsxs("div",{className:"flex justify-end gap-3 w-full",children:[e.jsx(b,{variant:"ghost",onClick:S,children:"Cancel"}),e.jsx(b,{variant:"primary",onClick:R,disabled:!y.trim(),leftIcon:e.jsx(bt,{size:16}),children:"Create Assembly"})]});return e.jsx(le,{isOpen:x,onClose:S,title:"Add New Assembly",size:"md",footerContent:g,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"Assembly Name *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:y,onChange:n=>{h(n.target.value),M&&N("")},placeholder:"e.g., Central Assembly",className:"flex-1 px-4 py-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-primary)] focus:ring-2 focus:ring-[var(--primary-accent-start)] outline-none transition-all",autoFocus:!0}),e.jsxs(ze,{value:"",onValueChange:n=>{n&&(h(n),M&&N(""))},children:[e.jsx(Ae,{className:"w-[140px] border-[var(--border-color)] bg-[var(--bg-elevated)]",children:e.jsx(Le,{placeholder:"Quick Select"})}),e.jsx(Re,{className:"bg-[var(--bg-elevated)] border-[var(--border-color)]",children:Oe.filter(n=>!z.includes(n)).map(n=>e.jsx(Ee,{value:n,children:n},n))})]})]}),e.jsx("p",{className:"mt-1 text-xs text-[var(--text-muted)]",children:"Select from defaults or type a custom name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"Master List (Optional)"}),e.jsxs("div",{onDragOver:O,onDragLeave:L,onDrop:P,onClick:()=>{var n;return(n=$.current)==null?void 0:n.click()},className:`
                            border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-all
                            ${u?"border-[var(--primary-accent-start)] bg-[var(--primary-accent-start)]/10":"border-[var(--border-color)] hover:border-[var(--primary-accent-start)] hover:bg-[var(--bg-elevated)]"}
                        `,children:[e.jsx("input",{ref:$,type:"file",accept:".xlsx, .xls",onChange:v,className:"hidden"}),A?e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"p-3 bg-green-100 dark:bg-green-900/30 rounded-full text-green-600 dark:text-green-400",children:e.jsx(mt,{size:24})}),e.jsx("div",{className:"font-medium text-[var(--text-primary)]",children:A.name}),e.jsxs("div",{className:"text-xs text-[var(--text-tertiary)]",children:[(A.size/1024).toFixed(1)," KB"]}),e.jsx("button",{onClick:n=>{n.stopPropagation(),a(null)},className:"text-xs text-red-500 hover:text-red-600 mt-1",children:"Remove file"})]}):e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"p-3 bg-[var(--bg-elevated)] rounded-full text-[var(--text-secondary)]",children:e.jsx(pe,{size:24})}),e.jsx("div",{className:"font-medium text-[var(--text-secondary)]",children:"Click to upload or drag and drop"}),e.jsx("div",{className:"text-xs text-[var(--text-tertiary)]",children:"Excel files only (.xlsx, .xls)"})]})]})]}),M&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-800",children:[e.jsx(Fe,{size:16}),e.jsx("span",{children:M})]})]})})},jt=({member:x,index:S,onMoveClick:p})=>{const{attributes:z,listeners:y,setNodeRef:h,transform:A,transition:a,isDragging:u}=Ke({id:x.id}),j={transform:Ge.Transform.toString(A),transition:a,opacity:u?.5:1,zIndex:u?1e3:"auto"};return e.jsxs("div",{ref:h,style:j,className:`group flex items-center gap-3 p-3 bg-[var(--bg-card)] border border-[var(--border-color)] rounded-lg mb-2 ${u?"shadow-lg ring-2 ring-[var(--primary-accent-start)]":""} hover:bg-[var(--bg-elevated)] transition-colors`,children:[e.jsx("div",{...z,...y,className:"cursor-grab active:cursor-grabbing p-1 hover:bg-[var(--bg-secondary)] rounded",children:e.jsx(se,{size:18,className:"text-[var(--text-muted)]"})}),e.jsx("div",{className:"w-10 h-10 flex items-center justify-center bg-[var(--primary-accent-start)] text-white rounded-full font-bold text-sm",children:S+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-[var(--text-primary)] truncate",children:x.displayName}),e.jsx("p",{className:"text-xs text-[var(--text-muted)] truncate",children:x.memberId})]}),x.titheBookIndex!==S+1&&e.jsxs("div",{className:"text-xs text-orange-500 font-medium",children:["was #",x.titheBookIndex]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),p(x)},title:"Move to Target Position",className:"opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(ue,{size:16,className:"text-[var(--primary-accent-start)]"})})]})},Nt=({isOpen:x,onClose:S,assemblyName:p,orderedMembers:z,onSaveComplete:y,addToast:h,masterList:A,onOpenHistory:a})=>{const[u,j]=o.useState([]),[M,N]=o.useState(""),[$,v]=o.useState(!1),[O,L]=o.useState(!1),[P,R]=o.useState("1"),[g,n]=o.useState(null),I=$e.useRef(null);o.useEffect(()=>{x&&z.length>0&&(j([...z]),L(!1),N(""),n(null),R("1"))},[x,z]);const D=M?u.filter(l=>l.displayName.toLowerCase().includes(M.toLowerCase())||l.memberId.toLowerCase().includes(M.toLowerCase())):u;o.useEffect(()=>{M&&D.length>0?n(D[0]):M&&D.length===0&&n(null)},[M,u]);const q=o.useCallback((l=g)=>{if(!l)return;const w=parseInt(P,10);if(isNaN(w)||w<1||w>u.length){h(`Invalid position. Enter 1-${u.length}`,"error");return}const k=u.findIndex(V=>V.id===l.id);if(k===-1)return;const f=w-1,B=u[f],_=B?`Swapped with "${B.displayName}" at #${w}`:`Moved to #${w}`;j(V=>{const r=[...V],m=r[f];return r[f]=r[k],r[k]=m,r}),L(!0),h(`Moved "${l.displayName}" to #${w}. ${_}`,"success"),R(String(Math.min(w+1,u.length))),g&&g.id===l.id&&(N(""),n(null))},[g,P,u,h]),H=Pe(fe(Ue,{activationConstraint:{distance:5}}),fe(Be,{coordinateGetter:De})),J=o.useCallback(l=>{const{active:w,over:k}=l;k&&w.id!==k.id&&j(f=>{const B=f.findIndex(V=>V.id===w.id),_=f.findIndex(V=>V.id===k.id);return L(!0),He(f,B,_)})},[]),Y=o.useCallback(()=>{j([...z]),L(!1)},[z]),ee=o.useCallback(()=>{if(!A||A.length===0){h("Master list not available for reset","error");return}if(confirm("This will revert the order to match the original Master List order. Proceed?")){const l=new Map;A.forEach((k,f)=>{const B=(k["Membership Number"]||k["Old Membership Number"]||"").toLowerCase();l.set(B,f)});const w=[...u].sort((k,f)=>{const B=l.get(k.memberId.toLowerCase())??9999,_=l.get(f.memberId.toLowerCase())??9999;return B-_});j(w),L(!0),h("Order reset to match Master List. Click Save to apply.","info")}},[u,A,h]),Z=async()=>{try{const l=await Je(p),w=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),k=URL.createObjectURL(w),f=document.createElement("a");f.href=k,f.download=`${p.replace(/\s+/g,"_")}_order_${new Date().toISOString().split("T")[0]}.json`,f.click(),URL.revokeObjectURL(k),h("Order exported successfully","success")}catch(l){console.error(l),h("Failed to export order","error")}},Q=async l=>{var k;const w=(k=l.target.files)==null?void 0:k[0];if(w){try{const f=await w.text(),B=JSON.parse(f),_=await Ze(B,p);_.success?(h(`Imported ${_.imported} member orders. Modal will close to refresh.`,"success"),y(),S()):h(_.errors.join(", "),"error")}catch(f){console.error(f),h("Failed to import order file","error")}l.target.value=""}},T=async()=>{v(!0);try{const l=u.map((k,f)=>({memberId:k.memberId,newIndex:f+1})),w=`manual-reorder-${Date.now()}-${Math.random().toString(36).substr(2,6)}`;await me(p,w),await xe(l,p),await he({assemblyName:p,action:"manual",timestamp:Date.now(),description:`Manually reordered ${l.length} members`,affectedCount:l.length},w),h(`Member order saved for ${p}`,"success"),L(!1),y(),S()}catch(l){console.error("Failed to save member order:",l),h("Failed to save member order","error")}finally{v(!1)}},X=!M;return e.jsx(le,{isOpen:x,onClose:S,title:`Reorder Members - ${p}`,size:"lg",footerContent:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 flex gap-2",children:e.jsxs("div",{className:"relative group",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>{},children:"Actions"}),e.jsxs("div",{className:"absolute bottom-full left-0 mb-2 hidden group-hover:block bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded shadow-lg p-2 min-w-[150px]",children:[e.jsx(b,{variant:"ghost",size:"sm",className:"w-full justify-start text-xs",onClick:Z,leftIcon:e.jsx(ht,{size:14}),children:"Export Order"}),e.jsx(b,{variant:"ghost",size:"sm",className:"w-full justify-start text-xs",onClick:()=>{var l;return(l=I.current)==null?void 0:l.click()},leftIcon:e.jsx(Ce,{size:14}),children:"Import Order"}),e.jsx(b,{variant:"ghost",size:"sm",className:"w-full justify-start text-xs",onClick:a,leftIcon:e.jsx(be,{size:14}),children:"View History"}),e.jsx(b,{variant:"ghost",size:"sm",className:"w-full justify-start text-xs text-orange-500 hover:text-orange-600",onClick:ee,leftIcon:e.jsx(we,{size:14}),children:"Reset to Master List"})]})]})}),e.jsx("input",{ref:I,type:"file",accept:".json",className:"hidden",onChange:Q}),e.jsx(b,{variant:"ghost",onClick:S,disabled:$,children:"Cancel"}),e.jsx(b,{variant:"secondary",onClick:Y,disabled:!O||$,leftIcon:e.jsx(ke,{size:16}),title:"Undo changes made in this session",children:"Undo"}),e.jsx(b,{variant:"primary",onClick:T,disabled:!O||$,isLoading:$,leftIcon:e.jsx(We,{size:16}),children:"Save Order"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-[var(--text-secondary)]",children:["Drag and drop to reorder. Or use ",e.jsx("b",{children:"Target Pos"})," to quickly move members: set the position number, then click the ",e.jsx(ue,{size:14,className:"inline text-[var(--primary-accent-start)]"})," icon on a row."]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-muted)]",size:18}),e.jsx("input",{type:"text",placeholder:"Search members...",value:M,onChange:l=>N(l.target.value),onKeyDown:l=>{l.key==="Enter"&&g?(l.preventDefault(),q()):l.key==="Escape"&&(n(null),N(""))},className:"w-full pl-10 pr-4 py-2 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-accent-start)] focus:border-transparent"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium text-[var(--text-secondary)] whitespace-nowrap",children:"Target Pos:"}),e.jsx("input",{type:"number",min:"1",max:u.length||1,value:P,onChange:l=>R(l.target.value),className:"w-16 px-2 py-2 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg text-center focus:ring-2 focus:ring-[var(--primary-accent-start)]"})]})]}),g&&e.jsxs("div",{className:"p-2.5 bg-[var(--primary-accent-start)]/10 border border-[var(--primary-accent-start)]/30 rounded-lg text-sm flex items-center justify-between",children:[e.jsxs("span",{children:["Move ",e.jsx("strong",{className:"text-[var(--text-primary)]",children:g.displayName})," to position"," ",e.jsx("strong",{className:"text-[var(--text-primary)]",children:P}),"? Press Enter or click Move."]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>n(null),leftIcon:e.jsx(ie,{size:14}),children:"Cancel"}),e.jsx(b,{size:"sm",variant:"primary",onClick:()=>q(),leftIcon:e.jsx(gt,{size:14}),children:"Move"})]})]}),M&&!g&&e.jsx("p",{className:"text-xs text-amber-500",children:"⚠️ Drag disabled while searching. Use Target Pos & clicking to move."}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-[var(--text-muted)]",children:[e.jsxs("span",{children:[D.length," of ",u.length," members"]}),O&&e.jsx("span",{className:"text-orange-500 font-medium",children:"Unsaved changes"})]}),e.jsx("div",{className:"max-h-[50vh] overflow-y-auto pr-2",children:X?e.jsx(_e,{sensors:H,collisionDetection:qe,onDragEnd:J,children:e.jsx(Te,{items:u.map(l=>l.id),strategy:Ve,children:u.map((l,w)=>e.jsx(jt,{member:l,index:w,onMoveClick:q},l.id))})}):D.map(l=>{const w=u.findIndex(f=>f.id===l.id),k=(g==null?void 0:g.id)===l.id;return e.jsxs("div",{onClick:()=>n(l),className:`group flex items-center gap-3 p-3 bg-[var(--bg-card)] border rounded-lg mb-2 cursor-pointer transition-all ${k?"border-[var(--primary-accent-start)] ring-2 ring-[var(--primary-accent-start)]/30 bg-[var(--primary-accent-start)]/5":"border-[var(--border-color)] hover:bg-[var(--bg-elevated)]"}`,children:[e.jsx("div",{className:"p-1 opacity-30",children:e.jsx(se,{size:18,className:"text-[var(--text-muted)]"})}),e.jsx("div",{className:`w-10 h-10 flex items-center justify-center rounded-full font-bold text-sm ${k?"bg-[var(--primary-accent-start)] text-white":"bg-[var(--bg-secondary)] text-[var(--text-primary)]"}`,children:w+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-[var(--text-primary)] truncate",children:l.displayName.split(new RegExp(`(${M})`,"gi")).map((f,B)=>f.toLowerCase()===M.toLowerCase()?e.jsx("span",{className:"bg-yellow-300 dark:bg-yellow-600 rounded px-0.5",children:f},B):f)}),e.jsx("p",{className:"text-xs text-[var(--text-muted)] truncate",children:l.memberId})]}),k&&e.jsx("div",{className:"text-xs text-[var(--primary-accent-start)] font-medium",children:"Selected"}),e.jsx(b,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),q(l)},title:"Move to Target Position",className:"opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(ue,{size:16,className:"text-[var(--primary-accent-start)]"})})]},l.id)})})]})})},wt=({isOpen:x,onClose:S,assemblyName:p,memberDatabase:z,onSaveComplete:y,addToast:h,memberOrderMap:A})=>{const[a,u]=o.useState("upload"),[j,M]=o.useState([]),[N,$]=o.useState([]),[v,O]=o.useState([]),[L,P]=o.useState(!1),[R,g]=o.useState(!1),[n,I]=o.useState(null),[D,q]=o.useState(""),[H,J]=o.useState([]),Y=o.useRef(null),ee=o.useCallback(()=>{const t=v.filter(i=>i.matchedMember),s=[];for(const i of t){const d=i.matchedMember,C=(d["Membership Number"]||d["Old Membership Number"]||"").toLowerCase(),F=`${d.Surname||""} ${d["First Name"]||""}`.trim(),W=(A==null?void 0:A.get(C))??null,K=i.position;let re;W===null?re="new":W===K?re="unchanged":re="moved",s.push({memberId:C,memberName:F,currentPosition:W,newPosition:K,changeType:re,included:!0})}return s.sort((i,d)=>i.newPosition-d.newPosition),s},[v,A]),Z=o.useMemo(()=>{const t=H.filter(C=>C.changeType==="moved").length,s=H.filter(C=>C.changeType==="unchanged").length,i=H.filter(C=>C.changeType==="new").length,d=H.filter(C=>C.included&&C.changeType!=="unchanged").length;return{moved:t,unchanged:s,new:i,selected:d,total:H.length}},[H]),Q=o.useCallback(()=>{u("upload"),M([]),$([]),O([]),P(!1),I(null),q(""),J([]),S()},[S]),T=o.useCallback(t=>{const s=5-j.length;if(s<=0){h("Maximum 5 images allowed","warning");return}const i=t.slice(0,s),d=[];if(i.forEach(F=>{if(!F.type.startsWith("image/")){h(`Skipping non-image file: ${F.name}`,"warning");return}d.push(F)}),d.length===0)return;const C=F=>new Promise(W=>{const K=new FileReader;K.onloadend=()=>W(K.result),K.readAsDataURL(F)});Promise.all(d.map(C)).then(F=>{$(W=>[...W,...F])}),M(F=>[...F,...d])},[j,h]),X=o.useCallback(t=>{t.preventDefault();const s=Array.from(t.dataTransfer.files);s.length>0&&T(s)},[T]),l=o.useCallback(t=>{const s=t.target.files?Array.from(t.target.files):[];s.length>0&&T(s)},[T]),w=t=>{M(s=>s.filter((i,d)=>d!==t)),$(s=>s.filter((i,d)=>d!==t))},k=async()=>{if(j.length!==0){u("processing"),P(!0);try{const t="";if(!t)throw new Error("Gemini API key not configured");const s=[],i=await Ye(p);i.size>0&&console.log(`Loaded ${i.size} learned aliases for ${p}`);for(let C=0;C<j.length;C++){const W=(await vt(j[C],t,z,A,i)).matches.map(K=>({position:K.position,extractedName:K.extractedName,matchedMember:K.matchedMember,matchScore:K.confidence,isManuallyResolved:!1,alternatives:K.alternatives||[]}));s.push(...W)}s.sort((C,F)=>C.position-F.position),O(s);const d=s.filter(C=>!C.matchedMember).length;d>0?(u("preview"),h(`${d} names need manual resolution`,"warning")):(u("preview"),h(`All ${s.length} names matched successfully!`,"success"))}catch(t){console.error("Failed to extract names:",t),h(`Failed to process image: ${t instanceof Error?t.message:"Unknown error"}`,"error"),u("upload")}finally{P(!1)}}},f=o.useCallback(async(t,s)=>{const i=v[t];if(i&&i.extractedName)try{await Qe(p,i.extractedName,s),console.log(`Learned alias: "${i.extractedName}" → "${s["First Name"]} ${s.Surname}"`)}catch(d){console.warn("Failed to save alias:",d)}O(d=>d.map((C,F)=>F===t?{...C,matchedMember:s,matchScore:1,isManuallyResolved:!0}:C)),I(null),q("")},[p,v]),B=o.useCallback(t=>{O(s=>s.filter((i,d)=>d!==t))},[]),_=async()=>{const t=v.filter(s=>s.matchedMember);if(t.length===0){h("No valid matches to apply","error");return}g(!0);try{const s=t.map(d=>({memberId:d.matchedMember["Membership Number"]||d.matchedMember["Old Membership Number"]||"",newIndex:d.position})).filter(d=>d.memberId),i=`ai-reorder-${Date.now()}-${Math.random().toString(36).substr(2,6)}`;await me(p,i),await xe(s,p),await he({assemblyName:p,action:"ai_reorder",timestamp:Date.now(),description:`AI reordered ${s.length} members from tithe book image`,affectedCount:s.length},i),h(`Reordered ${s.length} members to match tithe book`,"success"),y(),Q()}catch(s){console.error("Failed to apply order:",s),h("Failed to save new order","error")}finally{g(!1)}},V=o.useCallback(()=>{const t=ee();J(t),u("diff")},[ee]),r=o.useCallback(t=>{J(s=>s.map((i,d)=>d===t?{...i,included:!i.included}:i))},[]),m=o.useCallback(t=>{J(s=>s.map(i=>({...i,included:t})))},[]),c=async()=>{const t=H.filter(s=>s.included&&s.changeType!=="unchanged");if(t.length===0){h("No changes selected to apply","warning");return}g(!0);try{const s=t.map(d=>({memberId:d.memberId,newIndex:d.newPosition})),i=`ai-reorder-${Date.now()}-${Math.random().toString(36).substr(2,6)}`;await me(p,i),await xe(s,p),await he({assemblyName:p,action:"ai_reorder",timestamp:Date.now(),description:`AI reordered ${s.length} members (selected from diff view)`,affectedCount:s.length},i),h(`Applied ${s.length} order changes`,"success"),y(),Q()}catch(s){console.error("Failed to apply changes:",s),h("Failed to apply changes","error")}finally{g(!1)}},E=D?z.filter(t=>{const s=`${t.Surname} ${t["First Name"]} ${t["Other Names"]||""}`.toLowerCase(),i=(t["Membership Number"]||"").toLowerCase();return s.includes(D.toLowerCase())||i.includes(D.toLowerCase())}).slice(0,10):[],U=v.filter(t=>!t.matchedMember).length;return e.jsx(le,{isOpen:x,onClose:Q,title:"Reorder from Tithe Book Image",size:"lg",footerContent:e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"ghost",onClick:Q,disabled:L||R,children:"Cancel"}),a==="upload"&&e.jsx(b,{variant:"primary",onClick:k,disabled:j.length===0||L,leftIcon:e.jsx(ge,{size:16}),children:"Extract Names"}),a==="preview"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"secondary",onClick:V,disabled:U>0||R,leftIcon:e.jsx(xt,{size:16}),children:"Review Changes"}),e.jsxs(b,{variant:"primary",onClick:_,disabled:U>0||R,isLoading:R,leftIcon:e.jsx(de,{size:16}),children:["Apply All (",v.filter(t=>t.matchedMember).length,")"]})]}),a==="diff"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"secondary",onClick:()=>u("preview"),disabled:R,children:"Back"}),e.jsxs(b,{variant:"primary",onClick:c,disabled:Z.selected===0||R,isLoading:R,leftIcon:e.jsx(de,{size:16}),children:["Apply Selected (",Z.selected,")"]})]})]}),children:e.jsxs("div",{className:"space-y-4",children:[a==="upload"&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-[var(--text-secondary)]",children:["Upload an image of the ",e.jsx("strong",{children:"NO."})," and ",e.jsx("strong",{children:"NAME"})," columns from your physical tithe book. The AI will extract the names and match them to your database."]}),e.jsxs("div",{className:`border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all ${j.length>0?"border-green-500 bg-green-500/10":"border-[var(--border-color)] hover:border-[var(--primary-accent-start)] hover:bg-[var(--bg-elevated)]"}`,onDrop:X,onDragOver:t=>t.preventDefault(),onClick:()=>{var t;j.length<5&&((t=Y.current)==null||t.click())},children:[e.jsx("input",{ref:Y,type:"file",accept:"image/*",multiple:!0,onChange:l,className:"hidden"}),N.length>0?e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[N.map((t,s)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:t,alt:`Upload ${s+1}`,className:"h-24 w-full object-cover rounded-lg shadow-sm"}),e.jsx("button",{className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",onClick:i=>{i.stopPropagation(),w(s)},children:e.jsx(ie,{size:12})}),e.jsx("span",{className:"absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-1 rounded",children:s+1})]},s)),j.length<5&&e.jsx("div",{className:"h-24 flex items-center justify-center border-2 border-dashed border-[var(--border-color)] rounded-lg text-[var(--text-muted)] hover:text-[var(--primary-accent-start)] hover:border-[var(--primary-accent-start)] transition-colors",children:e.jsxs("div",{className:"text-center",children:[e.jsx(pe,{size:20,className:"mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Add"})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{size:48,className:"mx-auto text-[var(--text-muted)] mb-3"}),e.jsx("p",{className:"text-lg font-medium text-[var(--text-primary)]",children:"Drop images here or click to browse"}),e.jsx("p",{className:"text-sm text-[var(--text-muted)] mt-2",children:"Support for up to 5 images (JPG, PNG)"})]})]}),j.length>0&&e.jsxs("p",{className:"text-sm text-center text-green-500 font-medium mt-2",children:["✓ ",j.length," images selected"]}),e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-sm text-amber-200",children:[e.jsx("strong",{children:"Tip:"})," For best results, capture a clear photo with both the NO. and NAME columns visible. The image should include the handwritten names you want to use for ordering."]})]}),a==="processing"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(we,{size:48,className:"mx-auto text-[var(--primary-accent-start)] mb-4 animate-spin"}),e.jsx("p",{className:"text-lg font-medium text-[var(--text-primary)]",children:"Extracting names from image..."}),e.jsx("p",{className:"text-sm text-[var(--text-muted)] mt-2",children:"This may take a few seconds"})]}),a==="preview"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"text-sm text-[var(--text-secondary)]",children:"Review the extracted names and matches below."}),U>0&&e.jsxs("span",{className:"px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-sm font-medium",children:[U," unmatched"]})]}),e.jsx("div",{className:"max-h-[50vh] overflow-y-auto border border-[var(--border-color)] rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--bg-elevated)] sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-left font-medium w-12",children:"#"}),e.jsx("th",{className:"p-3 text-left font-medium",children:"Extracted Name"}),e.jsx("th",{className:"p-3 text-left font-medium",children:"Matched Member"}),e.jsx("th",{className:"p-3 text-center font-medium w-24",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-[var(--border-color)]",children:v.map((t,s)=>e.jsxs("tr",{className:t.matchedMember?"":"bg-amber-500/5",children:[e.jsx("td",{className:"p-3 text-[var(--primary-accent-start)] font-bold",children:t.position}),e.jsx("td",{className:"p-3 text-[var(--text-primary)]",children:t.extractedName}),e.jsx("td",{className:"p-3",children:n===s?e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"text",placeholder:"Search members...",value:D,onChange:i=>q(i.target.value),className:"w-full px-3 py-1 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded text-sm",autoFocus:!0}),E.length>0&&e.jsx("div",{className:"bg-[var(--bg-card)] border border-[var(--border-color)] rounded max-h-32 overflow-y-auto",children:E.map((i,d)=>e.jsxs("div",{className:"px-3 py-2 hover:bg-[var(--bg-elevated)] cursor-pointer text-sm",onClick:()=>f(s,i),children:[i.Surname," ",i["First Name"]," (",i["Membership Number"],")"]},d))})]}):t.matchedMember?e.jsxs("span",{className:"text-green-400",children:[t.matchedMember.Surname," ",t.matchedMember["First Name"],t.isManuallyResolved&&e.jsx("span",{className:"ml-2 text-xs text-blue-400",children:"(manual)"})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("span",{className:"text-amber-400 flex items-center gap-1",children:[e.jsx(Xe,{size:14})," No match found"]}),t.alternatives.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1 mt-1",children:[e.jsx("span",{className:"text-xs text-[var(--text-muted)]",children:"Suggestions:"}),t.alternatives.map((i,d)=>e.jsxs("button",{className:"px-2 py-0.5 text-xs bg-blue-500/20 text-blue-300 rounded hover:bg-blue-500/40 transition-colors",onClick:()=>f(s,i.member),title:`Score: ${(i.score*100).toFixed(0)}%`,children:[i.member.Surname," ",i.member["First Name"]]},d))]})]})}),e.jsxs("td",{className:"p-3 text-center",children:[!t.matchedMember&&n!==s&&e.jsxs("div",{className:"flex gap-1 justify-center",children:[e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>I(s),title:"Manually assign member",children:e.jsx(ge,{size:14})}),e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>B(s),title:"Skip this name",children:e.jsx(ie,{size:14})})]}),n===s&&e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>{I(null),q("")},children:e.jsx(ie,{size:14})})]})]},s))})]})})]}),a==="diff"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-[var(--text-secondary)]",children:"Review changes before applying. Uncheck changes you want to skip."}),e.jsxs("div",{className:"flex gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded",children:[Z.moved," moved"]}),e.jsxs("span",{className:"px-2 py-1 bg-green-500/20 text-green-400 rounded",children:[Z.unchanged," same"]}),Z.new>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-500/20 text-blue-400 rounded",children:[Z.new," new"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>m(!0),children:"Select All"}),e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>m(!1),children:"Deselect All"})]}),e.jsx("div",{className:"max-h-[50vh] overflow-y-auto border border-[var(--border-color)] rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--bg-elevated)] sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-center font-medium w-10",children:"✓"}),e.jsx("th",{className:"p-3 text-left font-medium",children:"Member"}),e.jsx("th",{className:"p-3 text-center font-medium w-20",children:"Current"}),e.jsx("th",{className:"p-3 text-center font-medium w-8",children:e.jsx(ve,{size:14})}),e.jsx("th",{className:"p-3 text-center font-medium w-20",children:"New"}),e.jsx("th",{className:"p-3 text-center font-medium w-24",children:"Status"})]})}),e.jsx("tbody",{className:"divide-y divide-[var(--border-color)]",children:H.map((t,s)=>e.jsxs("tr",{className:`${t.included?"":"opacity-50"} ${t.changeType==="moved"?"bg-yellow-500/5":t.changeType==="new"?"bg-blue-500/5":""}`,children:[e.jsx("td",{className:"p-3 text-center",children:e.jsx("input",{type:"checkbox",checked:t.included,onChange:()=>r(s),className:"w-4 h-4 rounded border-[var(--border-color)] accent-[var(--primary-accent-start)]"})}),e.jsx("td",{className:"p-3 text-[var(--text-primary)]",children:t.memberName}),e.jsx("td",{className:"p-3 text-center font-mono text-[var(--text-muted)]",children:t.currentPosition??"—"}),e.jsx("td",{className:"p-3 text-center text-[var(--text-muted)]",children:e.jsx(ve,{size:14,className:"inline"})}),e.jsx("td",{className:"p-3 text-center font-mono font-bold text-[var(--primary-accent-start)]",children:t.newPosition}),e.jsxs("td",{className:"p-3 text-center",children:[t.changeType==="moved"&&e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-400",children:"Moved"}),t.changeType==="unchanged"&&e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-green-500/20 text-green-400",children:"Same"}),t.changeType==="new"&&e.jsx("span",{className:"text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400",children:"New"})]})]},`${t.memberId}-${t.newPosition}-${s}`))})]})})]})]})})},kt={reorder:e.jsx(se,{size:16,className:"text-purple-400"}),import:e.jsx(Me,{size:16,className:"text-blue-400"}),reset:e.jsx(ke,{size:16,className:"text-red-400"}),ai_reorder:e.jsx(ge,{size:16,className:"text-amber-400"}),manual:e.jsx(se,{size:16,className:"text-green-400"})},Mt={reorder:"Manual Reorder",import:"Imported Order",reset:"Order Reset",ai_reorder:"AI Reorder",manual:"Manual Change"},Ct=({isOpen:x,onClose:S,assemblyName:p,onRestore:z,addToast:y})=>{const[h,A]=o.useState([]),[a,u]=o.useState([]),[j,M]=o.useState(!1),[N,$]=o.useState(!1),[v,O]=o.useState(null);o.useEffect(()=>{x&&p&&(M(!0),O(null),Promise.all([et(p),tt(p)]).then(([g,n])=>{A(g),u(n)}).finally(()=>M(!1)))},[x,p]);const L=o.useCallback(g=>a.find(n=>n.historyEntryId===g),[a]),P=async g=>{$(!0);try{const n=await st(g);n.success?(y==null||y(`Restored order (${n.restoredCount} members)`,"success"),z==null||z(),S()):y==null||y(n.error||"Failed to restore","error")}catch(n){console.error("Restore failed:",n),y==null||y("Failed to restore order","error")}finally{$(!1),O(null)}},R=g=>new Date(g).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return e.jsx(le,{isOpen:x,onClose:S,title:`Order History - ${p}`,size:"md",footerContent:e.jsx(b,{variant:"ghost",onClick:S,children:"Close"}),children:e.jsx("div",{className:"space-y-4",children:j?e.jsx("div",{className:"text-center py-8 text-[var(--text-muted)]",children:"Loading history..."}):h.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(be,{size:48,className:"mx-auto text-[var(--text-muted)] mb-3 opacity-50"}),e.jsx("p",{className:"text-[var(--text-muted)]",children:"No order changes recorded yet"}),e.jsx("p",{className:"text-sm text-[var(--text-muted)] mt-1",children:"Changes will appear here when you reorder, import, or reset member order."})]}):e.jsxs(e.Fragment,{children:[a.length>0&&e.jsxs("div",{className:"text-xs text-[var(--text-muted)] flex items-center gap-1",children:[e.jsx(ye,{size:12}),e.jsxs("span",{children:[a.length," restore point",a.length>1?"s":""," available"]})]}),e.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-y-auto",children:h.map((g,n)=>{const I=L(g.id),D=v===(I==null?void 0:I.id);return e.jsxs("div",{className:`flex gap-3 p-3 rounded-lg border ${n===0?"bg-[var(--primary-accent-start)]/10 border-[var(--primary-accent-start)]/30":"bg-[var(--bg-elevated)] border-[var(--border-color)]"}`,children:[e.jsx("div",{className:"flex-shrink-0 mt-1",children:kt[g.action]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-[var(--text-primary)]",children:Mt[g.action]}),e.jsxs("span",{className:"text-xs px-2 py-0.5 bg-[var(--bg-card)] rounded-full text-[var(--text-muted)]",children:[g.affectedCount," members"]})]}),e.jsx("p",{className:"text-sm text-[var(--text-secondary)] mt-0.5",children:g.description}),e.jsx("p",{className:"text-xs text-[var(--text-muted)] mt-1",children:R(g.timestamp)})]}),I&&e.jsx("div",{className:"flex-shrink-0 flex items-center",children:D?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(b,{size:"sm",variant:"primary",onClick:()=>P(I.id),disabled:N,isLoading:N,children:"Confirm"}),e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>O(null),disabled:N,children:"Cancel"})]}):e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>O(I.id),title:"Restore to this point",leftIcon:e.jsx(ye,{size:14}),className:"text-blue-400 hover:text-blue-300 hover:bg-blue-500/10",children:"Restore"})})]},g.id)})})]})})})},Ot=()=>{var f,B,_,V;const{memberDatabase:x={},onUploadMasterList:S,onCreateTitheList:p,onEditMember:z,addToast:y,onAddAssembly:h}=rt(),A=o.useRef(null),[a,u]=o.useState(Object.keys(x).filter(r=>r!=="true")[0]||null),[j,M]=o.useState(""),[N,$]=o.useState([]),[v,O]=o.useState({key:"customOrder",direction:"asc"}),[L,P]=o.useState(new Map);o.useEffect(()=>{a&&a!=="ALL MEMBERS"&&te(a).then(r=>{const m=new Map;r.forEach(c=>m.set(c.memberId.toLowerCase(),c.titheBookIndex)),P(m)}).catch(r=>console.error("Failed to fetch member order:",r))},[a,(f=x[a||""])==null?void 0:f.lastUpdated]);const[R,g]=o.useState(""),[n,I]=o.useState(""),D=ae("addAssembly"),q=ae("memberReorder"),H=ae("reorderFromImage"),J=ae("orderHistory"),[Y,ee]=o.useState([]),Z=(r,m)=>{var E;const c=(E=r.target.files)==null?void 0:E[0];c&&S(c,m),r.target.value=""},Q=()=>{var m;if(!a||a==="ALL MEMBERS"){y("Please select a specific assembly to export","warning");return}const r=((m=x[a])==null?void 0:m.data)||[];if(r.length===0){y("No members to export","warning");return}try{const c=r.map((t,s)=>{const i=(t["Membership Number"]||t["Old Membership Number"]||"").toLowerCase();return{"No.":L.get(i)||s+1,"Membership Number":t["Membership Number"]||"","Old Membership Number":t["Old Membership Number"]||"",Title:t.Title||"","First Name":t["First Name"]||"",Surname:t.Surname||"","Other Names":t["Other Names"]||"",Sex:t.Sex||"","Date of Birth":t["Date of Birth"]||"","Phone Number":t["Phone Number"]||"","Residential Address":t["Residential Address"]||"","Hometown/Region":t["Hometown/Region"]||"","Marital Status":t["Marital Status"]||"","Employment Status":t["Employment Status"]||"",Occupation:t.Occupation||""}});c.sort((t,s)=>t["No."]-s["No."]);const E=ce.json_to_sheet(c);E["!cols"]=ct(c);const U=ce.book_new();ce.book_append_sheet(U,E,a),dt(U,`${a.replace(/\s+/g,"_")}_Members_${new Date().toISOString().split("T")[0]}.xlsx`),y("Member list exported successfully","success")}catch(c){console.error("Export failed:",c),y("Failed to export member list","error")}},T=o.useMemo(()=>{var m;if(!a)return[];let r=[];return a==="ALL MEMBERS"?Object.values(x).forEach(c=>{c&&c.data&&(r=[...r,...c.data])}):r=((m=x[a])==null?void 0:m.data)||[],j&&(r=r.filter(c=>Object.values(c).some(E=>String(E).toLowerCase().includes(j.toLowerCase())))),(R||n)&&(r=at(r,Number(R)||void 0,Number(n)||void 0)),v.key&&r.sort((c,E)=>{if(v.key==="customOrder"){const s=(c["Membership Number"]||c["Old Membership Number"]||"").toLowerCase(),i=(E["Membership Number"]||E["Old Membership Number"]||"").toLowerCase(),d=L.get(s),C=L.get(i),F=d!==void 0?d:c.customOrder||99999,W=C!==void 0?C:E.customOrder||99999;return v.direction==="asc"?F-W:W-F}const U=String(c[v.key]).toLowerCase(),t=String(E[v.key]).toLowerCase();return U<t?v.direction==="asc"?-1:1:U>t?v.direction==="asc"?1:-1:0}),r},[x,a,j,v,R,n,L]),X=r=>{v.key===r?v.direction==="asc"?O({key:r,direction:"desc"}):O({key:"customOrder",direction:"asc"}):O({key:r,direction:"asc"})},l=r=>{$(m=>m.some(c=>c["No."]===r["No."])?m.filter(c=>c["No."]!==r["No."]):[...m,r])},w=()=>{N.length===T.length?$([]):$(T)},k=()=>{if(N.length===0){y("Please select at least one member to create a list.","warning");return}if(a){const r=[...N].sort((m,c)=>{const E=(m["Membership Number"]||m["Old Membership Number"]||"").toLowerCase(),U=(c["Membership Number"]||c["Old Membership Number"]||"").toLowerCase(),t=L.get(E),s=L.get(U),i=t!==void 0?t:m.customOrder||99999,d=s!==void 0?s:c.customOrder||99999;return i-d});p(r,a)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Member Database"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(b,{variant:"primary",onClick:k,disabled:N.length===0,leftIcon:e.jsx(nt,{size:16}),children:["Create Tithe List (",N.length,")"]})})]}),e.jsxs("div",{className:"flex border-b border-[var(--border-color)] overflow-x-auto",children:[Object.keys(x).filter(r=>r!=="true").map(r=>e.jsx("button",{onClick:()=>u(r),className:`px-4 py-2 text-sm font-medium transition-colors duration-200 whitespace-nowrap ${a===r?"border-b-2 border-[var(--primary-accent-start)] text-[var(--primary-accent-start)]":"text-[var(--text-secondary)] hover:text-[var(--text-primary)]"}`,children:r},r)),e.jsx("button",{onClick:()=>D.open(),className:"px-3 py-2 text-lg text-[var(--text-tertiary)] hover:text-emerald-500 hover:bg-emerald-500/10 transition-colors rounded-md",title:"Add New Assembly",children:"+"}),e.jsx("button",{onClick:()=>u("ALL MEMBERS"),className:`ml-auto px-4 py-2 text-sm font-medium transition-colors duration-200 whitespace-nowrap ${a==="ALL MEMBERS"?"border-b-2 border-[var(--primary-accent-start)] text-[var(--primary-accent-start)]":"text-[var(--text-secondary)] hover:text-[var(--text-primary)]"}`,children:"ALL MEMBERS"})]}),a&&(x[a]||a==="ALL MEMBERS")?e.jsxs("div",{className:"content-card",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4 p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:a}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[a==="ALL MEMBERS"?T.length:(B=x[a])==null?void 0:B.data.length," members"]})]}),e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-[var(--bg-secondary)] p-1 rounded-md border border-[var(--border-color)]",children:[e.jsx(ot,{size:16,className:"text-gray-400 ml-2"}),e.jsx("input",{type:"number",placeholder:"Min Age",value:R,onChange:r=>g(r.target.value),className:"bg-transparent border-none text-sm w-20 focus:ring-0 p-1"}),e.jsx("span",{className:"text-gray-400",children:"-"}),e.jsx("input",{type:"number",placeholder:"Max Age",value:n,onChange:r=>I(r.target.value),className:"bg-transparent border-none text-sm w-20 focus:ring-0 p-1"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:18}),e.jsx("input",{type:"text",placeholder:"Search members...",value:j,onChange:r=>M(r.target.value),className:"pl-10 pr-4 py-2 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-accent-start)] focus:border-transparent w-64"})]}),e.jsx("input",{ref:A,type:"file",accept:".xlsx, .xls",onChange:r=>a&&Z(r,a),className:"hidden"}),a!=="ALL MEMBERS"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"secondary",leftIcon:e.jsx(se,{size:16}),onClick:async()=>{var r;if(a){let m=await te(a);const c=((r=x[a])==null?void 0:r.data)||[];if(m.length===0)c.length>0&&(await it(c,a),m=await te(a));else{const E=new Set(c.map(U=>(U["Membership Number"]||U["Old Membership Number"]||"").toLowerCase()));m=m.filter(U=>E.has(U.memberId.toLowerCase()))}ee(m),q.open()}},children:"Reorder"}),e.jsx(b,{variant:"secondary",leftIcon:e.jsx(ut,{size:16}),onClick:()=>H.open(),children:"AI Reorder"}),e.jsx(b,{variant:"ghost",leftIcon:e.jsx(Me,{size:16}),onClick:Q,children:"Export"}),e.jsx(b,{variant:"ghost",leftIcon:e.jsx(Ce,{size:16}),onClick:()=>{var r;return(r=A.current)==null?void 0:r.click()},children:"Import"}),e.jsx(b,{variant:"ghost",leftIcon:e.jsx(be,{size:16}),onClick:()=>J.open(),children:"History"})]})]})]}),e.jsx("div",{className:"border rounded-md border-[var(--border-color)] bg-[var(--bg-elevated)]",children:e.jsx(lt,{className:"h-[calc(100vh-280px)]",type:"always",children:e.jsxs("table",{className:"modern-table min-w-full divide-y divide-[var(--border-color)]",children:[e.jsx("thead",{className:"bg-[var(--bg-elevated)] sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"p-4",children:e.jsx(je,{checked:N.length===T.length&&T.length>0,onChange:()=>w()})}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700 dark:hover:text-gray-200 transition-colors",onClick:()=>X("customOrder"),title:"Tithe Book Order - Position in physical tithe book",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(pt,{size:14}),v.key==="customOrder"&&(v.direction==="asc"?e.jsx(oe,{size:14}):e.jsx(ne,{size:14}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700 dark:hover:text-gray-200 transition-colors",onClick:()=>X("First Name"),children:e.jsxs("div",{className:"flex items-center gap-1",children:["Name",v.key==="First Name"&&(v.direction==="asc"?e.jsx(oe,{size:14}):e.jsx(ne,{size:14}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700 dark:hover:text-gray-200 transition-colors",onClick:()=>X("Membership Number"),children:e.jsxs("div",{className:"flex items-center gap-1",children:["Membership No.",v.key==="Membership Number"&&(v.direction==="asc"?e.jsx(oe,{size:14}):e.jsx(ne,{size:14}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700 dark:hover:text-gray-200 transition-colors",onClick:()=>X("Phone Number"),children:e.jsxs("div",{className:"flex items-center gap-1",children:["Phone Number",v.key==="Phone Number"&&(v.direction==="asc"?e.jsx(oe,{size:14}):e.jsx(ne,{size:14}))]})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-[var(--border-color)]",children:T.map((r,m)=>e.jsxs("tr",{children:[e.jsx("td",{className:"p-4",children:e.jsx(je,{checked:N.some(c=>c["No."]===r["No."]),onChange:()=>l(r)})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-center text-[var(--primary-accent-start)] font-semibold",children:(()=>{const c=(r["Membership Number"]||r["Old Membership Number"]||"").toLowerCase();return L.get(c)||"-"})()}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-[var(--text-primary)]",children:[r["First Name"]," ",r.Surname]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400",children:r["Membership Number"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400",children:r["Phone Number"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>z(r,a),children:e.jsx(ft,{size:16})})})]},r["Membership Number"]||`${r["No."]}-${m}`))})]})})})]}):e.jsxs("div",{className:"text-center py-12 content-card",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No member databases found."}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:"Upload a master list for an assembly to get started."})]}),e.jsx(yt,{isOpen:D.isOpen,onClose:D.close,onConfirm:(r,m)=>{h==null||h(r),m&&S(m,r),D.close()},existingAssemblies:Object.keys(x)}),e.jsx(Nt,{isOpen:q.isOpen,onClose:q.close,assemblyName:a||"",orderedMembers:Y,onSaveComplete:async()=>{if(a){const r=await te(a),m=new Map;r.forEach(c=>m.set(c.memberId.toLowerCase(),c.titheBookIndex)),P(m)}},addToast:y,masterList:((_=x[a||""])==null?void 0:_.data)||[],onOpenHistory:()=>J.open()}),e.jsx(wt,{isOpen:H.isOpen,onClose:H.close,assemblyName:a||"",memberDatabase:((V=x[a||""])==null?void 0:V.data)||[],memberOrderMap:L,onSaveComplete:async()=>{if(a){const r=await te(a),m=new Map;r.forEach(c=>m.set(c.memberId.toLowerCase(),c.titheBookIndex)),P(m)}},addToast:y}),e.jsx(Ct,{isOpen:J.isOpen,onClose:J.close,assemblyName:a||"",addToast:y,onRestore:async()=>{if(a){const r=await te(a),m=new Map;r.forEach(c=>m.set(c.memberId.toLowerCase(),c.titheBookIndex)),P(m)}}})]})};export{Ot as default};
